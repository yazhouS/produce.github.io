<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <!-- 引入Mapbox GL JS的CSS样式 -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <!-- 引入Mapbox GL JS库 -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <!-- 引入Mapbox Geocoder插件 -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">
    <!-- 用于显示坐标信息的div -->
    <div id="info"></div>
    <!-- 自定义样式 -->
    <style>
        #map {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }

        #select_div {
            position: absolute;
            top: 20px;
            right: 168px;
            width: 20px;
            height: 20px;
            z-index: 100;
            border-radius: 20%;
        }

        #coordinate_div {
            position: absolute;
            bottom: 60px;
            left: 20px;
            color: blue;
            z-index: 100;
        }

        #coordinate_div>p {
            margin: 2px;
        }
    </style>
</head>

<body>
    <!-- 下拉选择框，用于切换地图样式 -->
    <div id="select_div">
        <select name="" id="select">
            <option value="satellite-streets-v11">satellite-streets-v11</option>
            <option value="streets-v11">streets-v11</option>
            <option value="dark-v10">dark-v10</option>
        </select>
    </div>
    <!-- 用于显示当前鼠标位置的经纬度信息的div -->
    <div id="coordinate_div">
        <p>Lng: <span id="longitude"></span></p>
        <p>Lat: <span id="latitude"></span></p>
    </div>
    <!-- Mapbox GL JS地图容器 -->
    <div id='map'></div>
    <script>
        // 设置Mapbox的访问令牌
        mapboxgl.accessToken = 'pk.eyJ1IjoieWFuZ2ppYW4iLCJhIjoiY2phaG1neno0MXFkNDMzbWhwNWw0bWM4aiJ9.CFmrh0LVWAbmVeed-Xr7wA';
        // 创建Mapbox GL JS的Map对象
        const map = new mapboxgl.Map({
            container: 'map', // 容器ID
            style: 'mapbox://styles/mapbox/satellite-streets-v12', // 初始样式
            center: [123.70786, 41.45673], // 初始中心点
            zoom: 2, // 初始缩放级别
            projection: 'globe' // 投影方式
        });
        // 添加全屏控制
        map.addControl(new mapboxgl.FullscreenControl());
        // 添加定位控件
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }));
        // 添加比例尺控件
        map.addControl(new mapboxgl.ScaleControl({
            maxWidth: 200,
            unit: 'metric'
        }), 'bottom-left');
        // 添加地理编码控件
        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
        }), 'top-left');
        // 添加导航控件
        map.addControl(new mapboxgl.NavigationControl(), 'top-left');

        // 地图加载完成事件
        map.on('load', function () {
            rotate(); // 开始自动旋转
        })
        // 样式加载完成事件
        map.on('style.load', function () {
            map.setFog({}) // 设置雾化效果
        })
        // 鼠标移动事件，更新经纬度信息
        map.on('mousemove', function (e) {
            document.getElementById('longitude').innerHTML = e.lngLat.lng.toFixed(5);
            document.getElementById('latitude').innerHTML = e.lngLat.lat.toFixed(5);
        });
        // 点击事件，停止自动旋转
        map.on('click', function (e) {
            if (!initFlag && rotateFlag) {
                cancelAnimationFrame(rotateFlag);
                rotateFlag = null;
            }
        })
        // 地图移动事件
        map.on('move', function (e) {

        })

        // 下拉选择框变化事件，切换地图样式
        document.querySelector('#select').addEventListener('change', function () {
            map.setStyle('mapbox://styles/mapbox/' + this.value);
        })

        // 延时设置地图样式和视角
        setTimeout(() => {
            // 取消自动旋转
            cancelAnimationFrame(rotateFlag);
            // 飞跃到指定位置
            map.flyTo({
                center: [123.70786, 41.45673],
                zoom: 18,
                speed: 0.4,
                pitch: 60,
            })
            // 添加地形数据源
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            // 设置地形效果
            map.setTerrain({
                source: 'mapbox-dem',
                exaggeration: 2,
            });
            // 延时开始自动旋转
            setTimeout(() => {
                initFlag = false;
                startTime = Date.now();
                rotateCamera(Date.now())
            }, 14000)

        }, 20000);

        // 旋转标志和初始化标志
        let rotateFlag = false;
        let initFlag = true;
        // 开始时间
        let startTime;

        // 旋转函数
        function rotate() {
            let center = map.getCenter();
            map.easeTo({
                center: [center.lng + 40, center.lat],
                zoom: 2,
                speed: 0.6
            })
            rotateFlag = requestAnimationFrame(rotate);
        }

        function rotateCamera(timestrip) {
            map.rotateTo((Date.now() - startTime) / 100 % 360, { duration: 0 });
            rotateFlag = requestAnimationFrame(rotateCamera);
        }

    </script>

</body>

</html>